<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>5m地形変化量表示マップ v3</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.min.js"></script>
  <script src="src/plugins/leaflet-tilelayer-glue.js"></script>
  <script src="src/elvchange_shaders.js"></script>
  <style>
    #map {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }
    .back-link {
      position: absolute;
      top: 58px;
      right: 12px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      color: #0b5ed7;
      padding: 6px 10px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      font-size: 12px;
      line-height: 18px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <a href="index.html" class="back-link">indexへ戻る</a>
  <div id="map"></div>

  <!-- 崩壊地GeoJSONデータの読み込み -->
  <script src="src/draw_houkai.js"></script>
  <script src="src/draw_houkai_wjw.js"></script>

  <script>
    var map = L.map("map", {
      zoom: 11,
      maxZoom: 17,
      center: [37.38906, 136.90990]
    });

    // ベースマップレイヤー
    var lyrBfCsMap = L.tileLayer(
      "https://www2.ffpri.go.jp/soilmap/tile/cs_noto/{z}/{x}/{y}.png",
      {
        minZoom: 8,
        maxZoom: 17,
        attribution: "森林総合研究所"
      }
    );

    var lyrCSMap = L.tileLayer(
      "https://forestgeo.info/opendata/17_ishikawa/noto/csmap_2024/{z}/{x}/{y}.webp",
      {
        minZoom: 8,
        maxZoom: 17,
        attribution: "林野庁"
      }
    );

    var lyrElvChange = L.tileLayer.glue(
      "https://forestgeo.info/opendata/17_ishikawa/noto/henka_2024/{z}/{x}/{y}.png",
      {
        attribution: "Forestry Agency",
        maxZoom: 17,
        maxNativeZoom: 14,
        opacity: 0.5,
        fragmentShader: colorMapShader
      }
    ).addTo(map);

    // オーバーレイレイヤー
    var lyrGSI = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
      {
        opacity: 0.5,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }
    );

    var lyrGSI2024ort = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_0405_0426do/{z}/{x}/{y}.png",
      {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }
    );

    var lyrGSI202409orte = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajimatobu_0924do_sokuho/{z}/{x}/{y}.png",
      {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }
    );

    var lyrGSI202409ortw = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajimaseibu_0924do_sokuho/{z}/{x}/{y}.png",
      {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }
    );

    // 旧地すべり地形分布図
    var landslideLayer = L.tileLayer(
      "https://jmapweb3v.bosai.go.jp/map/xyz/landslide/{z}/{x}/{y}.png",
      {
        format: "image/png",
        transparent: true,
        opacity: 0.7,
        minZoom: 5,
        maxZoom: 15,
        attribution: "<a href='http://www.j-shis.bosai.go.jp/JSHIS2/IMAGE/etc/landslide_v3_jp.png' target='_blank'>防災科研</a>"
      }
    );

    // 林野庁判読崩壊地・亀裂（PBFベクトルタイル）
    var lyrVectorLs = L.vectorGrid.protobuf(
      "https://forestgeo.info/opendata/17_ishikawa/noto/handoku_2024/{z}/{x}/{y}.pbf",
      {
        vectorTileLayerStyles: {
          'handoku_2024': {
            weight: 2,
            color: '#0000ff',
            fill: false
          },
          'handoku_2024_polygon': {
            weight: 2,
            color: '#0000ff',
            fill: true,
            fillColor: '#0000ff',
            fillOpacity: 0.2
          },
          'handoku_2024_point': {
            radius: 6,
            color: '#0000ff',
            fill: true,
            fillColor: '#0000ff',
            fillOpacity: 0.7
          }
        },
        interactive: true,
        maxNativeZoom: 17,
        minZoom: 8,
        maxZoom: 20,
        attribution: '林野庁（ベクトルタイル）',
        getFeatureId: function(f) { return f.id; }
      }
    );

    // レイヤーコントロール
    var baseMaps = {
      "地震前CS立体図": lyrBfCsMap,
      "地震後CS立体図": lyrCSMap
    };

    var overlayMaps = {
      "5m色別": lyrElvChange,
      "地理院地図": lyrGSI,
      "地震後写真": lyrGSI2024ort,
      "豪雨後写真東": lyrGSI202409orte,
      "豪雨後写真西": lyrGSI202409ortw,
      "地震崩壊地東部": jsonHoukai,
      "地震崩壊地西部": jsonHoukai_wjw,
      "旧地すべり地形": landslideLayer,
      "林野庁判読崩壊地・亀裂": lyrVectorLs
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // 凡例の追加
    var legend = L.control({ position: 'bottomleft' });

    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'legend');

      legendLabels.forEach(function(label) {
        var item = document.createElement('div');
        item.innerHTML = '<i style="background:' + label[1] + '"></i> ' + label[0];
        div.appendChild(item);
      });

      return div;
    };

    legend.addTo(map);

    // マップクリック時に標高値を取得
    map.on('click', function(e) {
      var latlng = e.latlng;
      var zoom = map.getZoom();

      // Web Mercator投影を使用してタイル座標を計算
      var x = (latlng.lng + 180) / 360 * Math.pow(2, zoom);
      var y = (1 - Math.log(Math.tan(latlng.lat * Math.PI / 180) + 1 / Math.cos(latlng.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom);

      var tileX = Math.floor(x);
      var tileY = Math.floor(y);
      var pixelX = Math.floor((x - tileX) * 256);
      var pixelY = Math.floor((y - tileY) * 256);

      // タイルのURL
      var tileUrl = "https://forestgeo.info/opendata/17_ishikawa/noto/henka_2024/" + zoom + "/" + tileX + "/" + tileY + ".png";

      // 画像を読み込んでピクセルデータを取得
      var img = new Image();
      img.crossOrigin = "anonymous";

      img.onload = function() {
        var canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        var imageData = ctx.getImageData(pixelX, pixelY, 1, 1);
        var data = imageData.data;

        // RGB値を0-1の範囲に正規化
        var r = data[0] / 255.0;
        var g = data[1] / 255.0;
        var b = data[2] / 255.0;

        var altitude = calculateAltitudeJS(r, g, b);

        // ポップアップを表示
        if (altitude === -9999.0) {
          L.popup()
            .setLatLng(latlng)
            .setContent('変化量: NA（データなし）')
            .openOn(map);
        } else {
          L.popup()
            .setLatLng(latlng)
            .setContent('変化量: ' + altitude.toFixed(2) + ' m<br/>座標: ' + latlng.lat.toFixed(5) + ', ' + latlng.lng.toFixed(5))
            .openOn(map);
        }
      };

      img.onerror = function() {
        L.popup()
          .setLatLng(latlng)
          .setContent('タイルデータの読み込みに失敗しました')
          .openOn(map);
      };

      img.src = tileUrl;
    });
  </script>
</body>

</html>
